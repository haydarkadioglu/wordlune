rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // == USER DATA (Words, Lists, etc.) ==
    // Users can only read and write to their own data subcollections.
    match /data/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // == USER PROFILES ==
    // Users can read and update their own profile.
    // No one can create a profile for someone else.
    // No one can delete profiles.
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null; // Typically on registration
    }
    
    // == USERNAMES (for uniqueness) ==
    // Anyone authenticated can read usernames to check for existence.
    // You can only create a username document if you are logged in.
    // You can only delete your own username document (as part of a username change).
    match /usernames/{username} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // == STORIES ==
    // Anyone can read stories.
    // Only admins can create, update, or delete stories.
    match /stories/{language}/{document=**} {
      allow read: if true;
      allow write: if request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // == ADMINS ==
    // Default deny all access to the admins collection for security.
    match /admins/{userId} {
       allow read: if request.auth != null && request.auth.uid == userId;
       allow list, create, update, delete: if false;
    }
  }
}
